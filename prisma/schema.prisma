// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  DOCTOR
  EMPLOYER
  ADMIN
}

enum JobApplicationStatus {
  PENDING
  EMPLOYER_APPROVED // Employer approved, waiting for doctor confirmation
  DOCTOR_CONFIRMED // Doctor confirmed, booking finalized
  EMPLOYER_REJECTED
  DOCTOR_REJECTED
  CANCELLED
  COMPLETED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum JobUrgency {
  HIGH
  MEDIUM
  LOW
}

enum JobStatus {
  OPEN
  CLOSED
  FILLED
}

enum JobType {
  FULL_TIME
  PART_TIME
  LOCUM
  CONTRACT
}

enum PayBasis {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

enum Reviewer {
  AUTOMATED
  ADMIN
}

enum NotificationType {
  JOB_APPLICATION_RECEIVED
  JOB_APPLICATION_APPROVED
  JOB_APPLICATION_CONFIRMED
  JOB_APPLICATION_REJECTED
  JOB_APPLICATION_CANCELLED
  JOB_POSTED
  REVIEW_RECEIVED
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  FACILITY_VERIFICATION_APPROVED
  FACILITY_VERIFICATION_REJECTED
  STAFF_INVITATION_RECEIVED
  STAFF_INVITATION_ACCEPTED
  STAFF_INVITATION_REJECTED
  STAFF_REMOVED
  REMINDER_UPCOMING_JOB
  PAYMENT_RECEIVED
  MESSAGE_RECEIVED
}

model User {
  id                  String         @id
  name                String
  email               String
  emailVerified       Boolean        @default(false)
  image               String?
  roles               UserRole[]     @default([USER])
  phoneNumber         String?        @unique
  phoneNumberVerified Boolean        @default(false)
  location            String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @default(now()) @updatedAt
  sessions            Session[]
  accounts            Account[]
  doctorProfile       DoctorProfile?
  staffProfile        StaffProfile?
  ownedFacilities     Facility[]     @relation("FacilityOwner")
  notifications       Notification[]

  @@unique([email])
  @@map("user")
}

model DoctorProfile {
  id                 String              @id @default(cuid())
  userId             String              @unique
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  facilityReviews    FacilityReview[] // Reviews written by this doctor about facilities
  doctorReviews      DoctorReview[] // Reviews received by this doctor from facilities
  jobApplications    JobApplication[]
  doctorVerification DoctorVerification?
  bookmarks          JobBookmark[]
  notifications      Notification[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@map("doctor_profile")
}

model DoctorVerification {
  id                 String             @id @default(cuid())
  doctorProfileId    String             @unique
  doctorProfile      DoctorProfile      @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  fullName           String
  location           String
  specialty          String?
  yearsOfExperience  Int
  provisionalId      String?
  fullId             String?
  apcNumber          String
  apcDocumentUrl     String
  verificationStatus VerificationStatus @default(PENDING)
  rejectionReason    String?
  reviewedBy         Reviewer?
  allowAppeal        Boolean            @default(true)
  submittedAt        DateTime           @default(now())
  reviewedAt         DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@map("doctor_verification")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Facility {
  id                   String                @id @default(cuid())
  name                 String
  address              String
  contactEmail         String
  contactPhone         String
  profileImage         String?
  description          String?
  website              String?
  operatingHours       String?
  facilitiesServices   String[]              @default([])
  ownerId              String                @unique
  owner                User                  @relation("FacilityOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  jobs                 Job[]
  facilityReviews      FacilityReview[] // Reviews received by this facility from doctors
  doctorReviews        DoctorReview[] // Reviews written by this facility about doctors
  contactInfo          ContactInfo[]
  staffs               StaffProfile[]
  staffInvitations     StaffInvitation[]
  facilityVerification FacilityVerification?
  notifications        Notification[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([ownerId])
  @@map("facility")
}

model Job {
  id                  String           @id @default(cuid())
  title               String?
  description         String?
  location            String?
  payRate             String
  payBasis            PayBasis
  startTime           String
  endTime             String
  startDate           DateTime
  endDate             DateTime
  jobType             JobType
  urgency             JobUrgency       @default(LOW)
  status              JobStatus        @default(OPEN)
  requiredSpecialists String[]
  facilityId          String
  facility            Facility         @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  applicants          JobApplication[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  staff               StaffProfile?    @relation(fields: [staffId], references: [id])
  staffId             String?
  bookmarkedBy        JobBookmark[]
  notifications       Notification[]

  @@index([facilityId])
  @@index([status])
  @@index([urgency])
  @@map("job")
}

model JobApplication {
  id                 String               @id @default(cuid())
  jobId              String
  job                Job                  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  status             JobApplicationStatus @default(PENDING)
  coverLetter        String?
  appliedAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  DoctorProfile      DoctorProfile?       @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  doctorProfileId    String?
  // Double opt-in fields
  confirmationToken  String?              @unique
  employerApprovedAt DateTime?
  doctorConfirmedAt  DateTime?
  rejectedAt         DateTime?
  rejectionReason    String?
  // Cancellation fields
  cancelledAt        DateTime?
  cancellationReason String?
  // Review relations (one review per completed job per direction)
  facilityReview     FacilityReview? // Doctor's review of the facility
  doctorReview       DoctorReview? // Facility's review of the doctor
  notifications      Notification[]

  @@unique([jobId, doctorProfileId])
  @@index([jobId])
  @@index([doctorProfileId])
  @@index([confirmationToken])
  @@index([doctorProfileId, status]) // Composite index for efficient status-based queries per doctor
  @@map("job_application")
}

// Review written by a doctor about a facility after completing a job
model FacilityReview {
  id               String         @id @default(cuid())
  rating           Int
  comment          String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  doctorProfile    DoctorProfile  @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  doctorProfileId  String
  facility         Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  facilityId       String
  jobApplication   JobApplication @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)
  jobApplicationId String         @unique

  @@unique([doctorProfileId, jobApplicationId])
  @@index([facilityId])
  @@index([doctorProfileId])
  @@map("facility_review")
}

// Review written by a facility about a doctor after completing a job
model DoctorReview {
  id               String         @id @default(cuid())
  rating           Int
  comment          String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  doctorProfile    DoctorProfile  @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  doctorProfileId  String
  facility         Facility       @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  facilityId       String
  jobApplication   JobApplication @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)
  jobApplicationId String         @unique

  @@unique([facilityId, jobApplicationId])
  @@index([facilityId])
  @@index([doctorProfileId])
  @@map("doctor_review")
}

model ContactInfo {
  id         String   @id @default(cuid())
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  name       String
  position   String
  contact    String
  createdAt  DateTime @default(now())

  @@index([facilityId])
  @@map("facility_contact_info")
}

model StaffProfile {
  id          String   @id @default(cuid())
  facilityId  String
  createdJobs Job[]
  facility    Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  role        String // e.g., "staff", "manager", "admin", "hr"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([facilityId])
  @@map("facility_staff_profile")
}

model FacilityVerification {
  id                     String             @id @default(cuid())
  facilityId             String             @unique
  facility               Facility           @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  businessRegistrationNo String
  businessDocumentUrl    String
  licenseNumber          String?
  licenseDocumentUrl     String?
  verificationStatus     VerificationStatus @default(PENDING)
  rejectionReason        String?
  allowAppeal            Boolean            @default(true)
  submittedAt            DateTime           @default(now())
  reviewedAt             DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  @@map("facility_verification")
}

model JobBookmark {
  job             Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId           String
  createdAt       DateTime      @default(now())
  doctorProfile   DoctorProfile @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  doctorProfileId String

  @@id([jobId, doctorProfileId])
  @@map("job_bookmark")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  REVOKED
}

model StaffInvitation {
  id         String           @id @default(cuid())
  facilityId String
  facility   Facility         @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  email      String
  role       String // e.g., "staff", "manager", "admin", "hr"
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  invitedBy  String // userId of the owner/admin who sent invite
  acceptedAt DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@unique([facilityId, email])
  @@index([token])
  @@index([facilityId])
  @@index([email])
  @@map("facility_staff_invitation")
}

model Notification {
  id      String           @id @default(cuid())
  type    NotificationType
  title   String
  message String
  isRead  Boolean          @default(false)

  // Polymorphic recipient - either userId, doctorProfileId, or facilityId
  userId          String?
  user            User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctorProfileId String?
  doctorProfile   DoctorProfile? @relation(fields: [doctorProfileId], references: [id], onDelete: Cascade)
  facilityId      String?
  facility        Facility?      @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  // Optional relations to entities
  jobId            String?
  job              Job?            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobApplicationId String?
  jobApplication   JobApplication? @relation(fields: [jobApplicationId], references: [id], onDelete: Cascade)

  // Metadata
  metadata  Json? // Store additional data (e.g., review rating, payment amount)
  actionUrl String? // Deep link to relevant page

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isRead])
  @@index([doctorProfileId, isRead])
  @@index([facilityId, isRead])
  @@index([createdAt])
  @@map("notification")
}
